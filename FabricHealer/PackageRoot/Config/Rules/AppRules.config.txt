## These rules check if we are inside the run interval for the specific repair. If so, then cut (!). This means stop processing rules in this file.
## Note: interval is an internal predicate (no backing impl, only exists in this logic) to add convenience to the rule. Note interval's definition in Mitigate. 
## Think of this is a definition of both Mitigate and interval. Calling interval will run the Mitigate rule with supplied arguments.
Mitigate() :- interval(AppName=?source, RunInterval=?timespan), CheckInsideRunInterval(RunInterval=?timespan), !.
interval(AppName="fabric:/CpuStress", RunInterval=00:15:00).
interval(AppName="fabric:/ContainerFoo2", RunInterval=00:15:00).
interval(MetricName="ActiveTcpPorts", RunInterval=00:15:00).

## CPU - Percent In Use.
Mitigate(AppName="fabric:/CpuStress", MetricName="CpuPercent", MetricValue=?MetricValue) :- ?MetricValue >= 20, 
	GetRepairHistory(?repairCount, ?lastRunTime, RestartCodePackage), 
	?repairCount < 5,
    RestartCodePackage(MaxRepairs=5).


## Memory - Percent In Use.
Mitigate(AppName="fabric:/CpuStress", MetricName="MemoryPercent", MetricValue=?MetricValue) :- ?MetricValue >= 30, 
	GetRepairHistory(?repairCount, ?lastRunTime, RestartCodePackage), 
	?repairCount < 5,
	RestartCodePackage(MaxRepairs=5).


## Memory - Megabytes In Use.
Mitigate(AppName="fabric:/CpuStress", MetricName="MemoryMB") :- GetRepairHistory(?repairCount, ?lastRunTime, RestartCodePackage), 
	?repairCount < 5,
    RestartCodePackage(MaxRepairs=5).

Mitigate(AppName="fabric:/ContainerFoo2", MetricName="MemoryMB") :- GetRepairHistory(?repairCount, ?lastRunTime, RestartCodePackage), 
	?repairCount < 5, 
	RestartCodePackage(MaxRepairs=5).


## Active TCP Ports - Any app service.
Mitigate(MetricName="ActiveTcpPorts") :- GetRepairHistory(?repairCount, ?lastRunTime, RestartCodePackage), 
	?repairCount < 5,
	RestartCodePackage(MaxRepairs=5).


## Ephemeral Ports - Specific Application and its services.
Mitigate(AppName="fabric:/MyApp42", MetricName="EphemeralPorts", MetricValue=?MetricValue) :- ?MetricValue >= 250, 
	GetRepairHistory(?repairCount, ?lastRunTime, RestartCodePackage), 
	?repairCount < 5, 
	RestartCodePackage(MaxRepairs=5).